#!/usr/bin/env bash
set -euo pipefail

BASE_URL='https://ziglang.org/download/index.json'

get_platform() {
  local platform="$(uname | tr '[:upper:]' '[:lower:]')"

  case "$platform" in
    linux|freebsd)
      ;;
    darwin)
      platform="macos"
      ;;
    *)
      echo "Platform '${platform}' not supported!" >&2
      exit 1
      ;;
  esac

  echo -n $platform
}

get_arch() {
  local arch=""

  case "$(uname -m)" in
    x86_64|amd64)
      arch="x86_64"
      ;;
    *)
      echo "Arch '$(uname -m)' not supported!" >&2
      exit 1
      ;;
  esac

  echo -n $arch
}

get_versions() {
  local platform=$(get_platform)
  local arch=$(get_arch)

  local versions=""
  versions=$( \
    curl -s $BASE_URL \
    | sed -n 's/"tarball": ".*zig-'"$platform"'-'"$arch"'-\([0-9\.]*\).tar.*",/\1/p' \
    | sed -e 's/^[[:space:]]*//' \
    | sort -t. -k 1,1 -k 2,2n -k 3,3n -k 4,4n -k 5,5n \
    | tr '\n' ' ' \
  )

  echo -n $versions
}

echo $(get_versions) master
